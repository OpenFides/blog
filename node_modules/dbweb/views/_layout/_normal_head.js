var b_pushpin,b_messageshow;
var waitReadCount;

function refreshMessgeIcon() {
	$("#spnMsgCount").html(waitReadCount);
	if (waitReadCount == 0) {
		$("#iMsgIcon").removeClass("animated");
	} else {
		$("#iMsgIcon").addClass("animated");
	}
}
function initHead(eleName, userName, remoteAddr) {
	var curMenu = $("a[data-elementname='" + eleName + "']");
	curMenu.css("color", "black");
	curMenu.closest(".dropdown").addClass('open');


	$('#myNavmenu li.dropdown>a').on('click', function (event) {
		$("#myNavmenu li.dropdown").not(this).removeClass("open");
		$(this).parent().toggleClass('open');
	});

	if (!("WebSocket" in window)) {
		$("#liMessage").remove();
	} else {
		waitReadCount = 0;
		var sckUrl = 'ws://' + window.location.host + '/sockets/room';
		if (window.location.protocol == "https:") {
			sckUrl = 'wss://' + window.location.host + '/sockets/room';
		}
		var connection = new ReconnectingWebSocket(sckUrl);
		// When the connection is open, send some data to the server
		connection.onopen = function () {
			$("#btnSend").prop("disabled", false);
		};

		// Log errors
		connection.onerror = function (error) {
			console.log('WebSocket Error ' + error);
		};
		connection.onclose = function () {
			$("#btnSend").prop("disabled", true);
		};
		function displayMessage(obj){
			$("#divMessageBoard").append("<div class='mes_sender'>" + obj.From + " " + obj.Time + "</div>");
			$("#divMessageBoard").append("<div class='mes_body'>" + obj.Message + "</div>");
		}
		function getMessageList(){
			var mes = localStorage.getItem("message_data");
			var mesList =[];
			if(mes){
				mesList = eval("("+mes+")");
			}
			return mesList
		}
		function setLastMessageTime(tm){
			var pretime = getLastMessageTime();
			if(pretime){
				//比之前早，不设置
				if(pretime > tm){
					return;
				}
			}
			localStorage.setItem("message_lasttime",tm);
		}
		function getLastMessageTime(){
			return localStorage.getItem("message_lasttime");
		}
		function appendMessage(data){
			var mesList =getMessageList();
			//多个页面，会并发存入，需要判断是否已经存入
			if(mesList.length>0){
				//已经存入的，不再保存，防止同个消息保存多次
				if(mesList[mesList.length-1] == data){
					return;
				}
			}
			mesList.push(data);
			localStorage.setItem("message_data",JSON.stringify(mesList));
		}
		function clearMessage(){
			localStorage.removeItem("message_data");
		}
		// Log messages from the server
		connection.onmessage = function (e) {
			var obj = eval("(" + e.data + ")");
			appendMessage(e.data);
			var bottom = $("#divMessageBoard").scrollTop() >=
				$("#divMessageBoard").prop("scrollHeight") - $("#divMessageBoard").prop("offsetHeight");
			displayMessage(obj);
			if (bottom) {
				$("#divMessageBoard").scrollTop($("#divMessageBoard").prop("scrollHeight"));
			}
			var msgShow = $("#divMessage").is(":visible");
			if (!msgShow) {
				waitReadCount++;
				refreshMessgeIcon();
			}else{
				setLastMessageTime(obj.Time);
			}
		};
		$("#edtMessage").keydown(function (event) {
			if (event.which == 13) {
				$("#btnSend").click();
			}
		});
		$("#btnSend").click(function () {
			var mes = $("#edtMessage").val();
			if (mes == "") return;
			connection.send(JSON.stringify({
				MType: "message",
				From: userName,
				Addr: remoteAddr,
				Message: mes,
			}));
			$("#edtMessage").val("");
		});
		$("#btnMsgIcon").click(function () {
			var msgShow = $("#divMessage").is(":visible");
			$("#divMessage").toggle();
			msgShow = !msgShow;
			b_messageshow = msgShow;
			if (msgShow) {
				$("#divMessageBoard").scrollTop($("#divMessageBoard").prop("scrollHeight"));
				waitReadCount = 0;
				refreshMessgeIcon();
				//自动设置为最后一个最新的时间
				var list = getMessageList();
				if(list.length>0){
					setLastMessageTime(eval("("+list[list.length-1]+")").Time);
				}
			}
			setNormalHeaderUI();
			$(document).trigger("message-icon-click",msgShow);
		});
		//读取上次保存的未读消息，并显示
		(function () {
			waitReadCount = 0;
			var preMesList = getMessageList();
			var preLastTime = getLastMessageTime();
			for (var i = 0; i < preMesList.length; i++) {
				var obj = eval("(" + preMesList[i] + ")");
				displayMessage(obj);
				//计算未读的消息数
				if (preLastTime) {
					if(obj.Time > preLastTime){
						waitReadCount++;
					}
				}
			}
			if(!preLastTime){
				waitReadCount = preMesList.length;
			}
			refreshMessgeIcon();
		})();
	}
	$("#btnPushPin").click(function () {
		var btnThis = $(this);
		btnThis.toggleClass("active");
		var push = btnThis.hasClass("active");
		b_pushpin = push;
		setNormalHeaderUI();
		$(document).trigger("pushpin-click",push);
	});
	b_pushpin = localStorage.getItem("pushpin")==1;
	setNormalHeaderUI();
}
function setNormalHeaderUI() {
	var btnThis = $("#btnPushPin");
	if (b_pushpin) {
		btnThis.addClass("active");
	} else {
		btnThis.removeClass("active");
	}
	//为了在最后运行
	if (b_pushpin) {
		localStorage.setItem("pushpin", "1");
		$("#navTitle").removeClass("navbar-static-top").addClass("navbar-fixed-top");
		$("#divMessage").addClass("fix-top");
		if(b_messageshow){
			$("body").css("padding-top",$("#navTitle").outerHeight()+
				$("#divMessage").prop("scrollHeight")+"px");
		}else{
			$("body").css("padding-top",$("#navTitle").outerHeight()+"px");
		}
	} else {
		localStorage.removeItem("pushpin");
		$("#navTitle").removeClass("navbar-fixed-top").addClass("navbar-static-top");
		$("#divMessage").removeClass("fix-top");
		$("body").css("padding-top","0px");
	}
}
