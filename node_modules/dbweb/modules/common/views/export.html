<style>
.control-label{
	padding:0px;
}
.form-group {
    margin-bottom: 4px;
}
</style>
<form role="form" class="form-horizontal" action="{{.Req.URL.String}}" method="POST">
<div class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">数据导出{{template "helpicon" .}}</h4>
		
      </div>
      <div class="modal-body">
		<div class="form-group form-group">
			<label class="control-label col-md-1 bill-label">来源:</label>
			<div class="col-md-5">
				<p class="form-control-static">{{.More.FromElement.DisplayLabel}}</p>
			</div>
			<label class="control-label col-md-1 bill-label">记录数:</label>
			<div class="col-md-5">
				<p class="form-control-static">{{.More.RowCount}}</p>
			</div>
		</div>
		<div class="form-group form-group">
			<label for="selFormat" class="control-label col-md-1 bill-label">格式:</label>
			<div class="col-md-5">
				<select id="selFormat" name="selformat" class="form-control">
					<option value="csv">CSV</option>
					<option value="txt">Text(Tab分隔)</option>
					<option value="excel">Excel</option>
					<option value="json">Json</option>
					<option value="sqlite3">Sqlite3</option>
					<option value="mytable">我的数据表</option>
				</select>
			</div>
			<label for="selFormat" class="control-label col-md-1 bill-label">编码:</label>
			<div class="col-md-5">
				<select id="selEncoder" name="selencoding" class="form-control">
					<option value="utf8">UTF8</option>
					<option value="gbk">GBK(GB2312)</option>
				</select>
			</div>
		</div>
		<div class="form-group form-group-sm">
			<label class="control-label col-md-1 bill-label">数据库:</label>
			<div class="col-md-5">
				<select id="selDB" name="seldb" class="form-control select2">
					<option value="">(当前数据库)</option>
					{{range .More.DBNames}}
					<option>{{.}}</option>
					{{end}}
				</select>
			</div>
			<label class="control-label col-md-1 bill-label">表别名:</label>
			<div class="col-md-5">
				<input type="text" id="edtTableName" name="tablename" class="form-control" value="{{.More.DefaultTableName}}">
			</div>
		</div>
		<p class="help-block">将要导出的指标:</p>
		<table id="tabFields" class="table table-hover table-striped">
			<thead>
				<tr>
					<th>序号</th>
					<th>名称</th>
					<th>数据类型</th>
					<th>长度</th>
				</tr>
			</thead>
			<tbody>
			{{range $idx,$field:= .More.Fields}}
				<tr>
					<td>{{inc $idx}}</td>
					<td>
						<div class="checkbox checkbox-inline checkbox-success">
							<input type="checkbox" class="chkSelect" id="chk{{$idx}}" name="sel_{{.Name}}" checked="checked">
							<label class="lblFieldName" for="chk{{$idx}}">{{.Name}}</label>
						</div>
					</td>
					<td>{{.Type}}</td>
					<td>{{.MaxLength}}</td>
				</tr>
			{{end}}
			</tbody>
		</table>
		<div id="divError" class="alert alert-danger" role="alert" style="display:none"></div>
      </div>
      <div class="modal-footer">
			<button id="btnOk" type="submit" class="btn btn-primary">导出</button>
	        <button id="btnClose" type="button" class="btn btn-default">关闭</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
</form>
<script>
$("#selFormat").change(function(){
	switch($(this).val()){
		case "csv":
		case "txt":
		case "json":
		case "excel":
			$("#selEncoder").prop("disabled",false);
			$("#selDB").prop("disabled",true);
			$("#edtTableName").prop("disabled",true);
			break;
		case "sqlite3":
			$("#selEncoder").prop("disabled",true);
			$("#selDB").prop("disabled",true);
			$("#edtTableName").prop("disabled",true);
			break;
		case "mytable":
			$("#selEncoder").prop("disabled",true);
			$("#selDB").prop("disabled",false);
			$("#edtTableName").prop("disabled",false);
			break;
	}
});
$("#tabFields tbody .chkSelect").change(function(){
	if($(this).prop("checked")){
		$(this).closest("tr").removeClass("text-muted");
	}else{
		$(this).closest("tr").addClass("text-muted");
	}
});
$(".modal").modal({backdrop:"static"});
$("#btnClose").click(function(){
	window.close();
});
$("form").submit(function(){
	$("#tabFields tbody>tr").removeClass("has-error");
	$("#divError").hide();
	var error = false;
	if(!$("#tabFields tbody>tr .chkSelect").is(":checked")){
		$("#divError").html("没有选择导出的字段");
		error=true;
		$("#divError").show();
	}
	return !error;
});
$(function(){
	$("#selFormat").trigger("change");
})
//shift多项选则、取消功能
$(function () {
	var first = null;
	$("#tabFields :checkbox").click(function (e) {
		if (e.shiftKey && first != null) {
			var last = $(this).closest("tr").index() + 1;
			var imin = Math.min(first, last);
			var imax = Math.max(first, last);
			var flag = $(this).prop("checked");
			for (var i = imin; i <= imax; i++) {
				$("#tabFields tr").eq(i).find(":checkbox").prop("checked", flag);
			}
			first = null
		}
		if (!e.shiftKey) {
			first = $(this).closest("tr").index() + 1;
		}
	});
});
</script>