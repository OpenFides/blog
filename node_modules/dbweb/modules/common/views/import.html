<script src="[[concat (newFiles "/flib/uri.js/src/URI.js" "/flib/uri.js/src/URI.min.js")]]" type="text/javascript" charset="utf-8"></script>
<style type="text/css">
body{
	background-color:dimgray;
}
#divMain{
	max-width:780px;
    float: none;
    margin-left: auto;
    margin-right: auto;
	margin-bottom:0px;
}
.panel-footer{
	text-align:right;
}
.form-group {
    margin-bottom: 5px;
}
#sampleDiv{
	height:200px;
	overflow: auto;
}
#columnsDiv{
	height:200px;
	overflow: auto;
}
#sampleDiv table td{
	white-space:nowrap;
}

</style>
<div id="divMain">
	{{if .Req.URL.Query.Get "step"}}
	<div class="panel panel-default">
	<!-- Default panel contents -->
	<div class="panel-heading">{{.Element.DisplayLabel}}-指标对照设置</div>
		<div class="panel-body">
			<div class="panel panel-default">
				<div class="panel-heading">注意事项:</div>
				<div class="panel-body">
					<ol>
						<li>
						空行将被忽略，并且不被计入行号
						</li>
						<li>
						{{block "PK" .}}
						{{- range $idx,$fld :=.More.Fields -}}
							{{- if $fld.PrimaryKey -}}
								[<span class="text-info">{{$fld.Name}}</span>]
								{{- if gt $idx 0}}、{{end}}
							{{- end}}
						{{- end -}}
						{{end}}为空的行将被忽略
						</li>
						<li>
						{{template "PK" .}}重复的行，将以最后一行为准
						</li>
						<li>
						所有指标的前后空白字符，包括全半角空格、回车换行、制表符等将被清除
						</li>
					</ol>
				</div>
			</div>
			<div class="panel panel-default">
				<div class="panel-heading">参数设置</div>
				<form class="form-horizontal">
					<div class="form-group">
						<div class="checkbox checkbox-primary col-sm-6 col-sm-offset-1">
							<input type="checkbox" id="chkFirstLine" checked="checked">
							<label for="chkFirstLine">
								首行是标题行
							</label>
						</div>				
						<label class="col-sm-2 control-label">字符集:</label>
						<div class="col-sm-3">
							<label class="radio-inline">
								<input type="radio" name="charset" id="radUTF8" value="UTF8" checked="checked"> UTF8
							</label>
							<label class="radio-inline">
								<input type="radio" name="charset" id="radGBK" value="GBK"> GBK
							</label>
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-2 control-label">格式:</label>
						<div class="col-sm-6">
							<label class="radio-inline">
								<input type="radio" name="format" id="radUTF8" value="CSV" checked="checked"> CSV
							</label>
							<label class="radio-inline">
								<input type="radio" name="format" id="radGBK" value="TAB"> Tab分隔的文本
							</label>
							<label class="radio-inline">
								<input type="radio" name="format" id="radGBK" value="CUSTOM"> 自定义
							</label>
						</div>
						<span class="col-sm-4">
							<input type="input" id="edtCustom" class="form-control" maxlength="1">
						</span>
					</div>
				</form>
			</div>
			<div class="panel panel-default">
				<div class="panel-heading"><button type="button" id="btnRefresh" class="btn btn-primary">重新识别</button> 以下是识别出的前100行数据：</div>
				<div id="sampleDiv">
					<table class="table table-striped table-bordered table-hover table-condensed" id="tabData">
					</table>
				</div>
			</div>
			<div class="panel panel-default">
				<div class="panel-heading">以下是指标对照设置，可以对应列中设置成(指定值)，然后录入值来设置统一的值</div>
				<div id="columnsDiv">
					<table class="table table-striped table-bordered table-hover table-condensed" id="tabColumns">
						<thead>
							<tr>
								<th>序号</th>
								<th>指标名称</th>
								<th>类别</th>
								<th>对应列</th>
								<th>值</th>
								<th>备注</th>
							</tr>
						</thead>
						<tbody>
							{{range $idx,$field :=.More.Fields}}
							<tr>
								<td>{{inc $idx}}</td>
								<td>{{$field.Name}}</td>
								<td>{{if eq "MUST" $field.Style}}必须{{else}}正常{{end}}</td>
								<td><select class="selColumn form-control input" data-field-name="{{$field.Name}}" data-field-style="{{$field.Style}}"></select></td>
								<td><input type="text" class="edtValue form-control input-sm"></td>
								<td>{{$field.Remark}}</td>
							</tr>
							{{end}}
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<div class="panel-footer">
			<form id="frmPost" role="form" action="{{.Req.URL.String}}" method="POST">
				<a id="btnPrev" type="button" class="btn btn-default" href="{{.More.PrevUrl}}">上一步</a>
				<input type="hidden" name="param" id="hidParam">
				<button id="btnOk" type="submit" class="btn btn-default">导入</button>
			</form>
		</div>
	</div>
	<script>
	//data结构为
	//Head []string
	//Data [][]string
	function showSampleData(data){
		
		$("#tabData").empty();
		if(data.Error){
			$("#tabData").append($("<tr><td>" + data.Error + "</td></tr>"));
			return;
		}
		var thead = $("<thead>");
		var theadTr = $("<tr>");
		for(var i =0;i < data.Title.length;i++){
			theadTr.append($("<th>" + data.Title[i] + "</th>"));
		}
		thead.append(theadTr);
		$("#tabData").append(thead);
		var tbody = $("<tbody>");
		for(var row=0;row < data.Rows.length;row++){
			var tr =$("<tr>");
			for(var col=0;col < data.Rows[row].length;col++){
				tr.append($("<td>"+ data.Rows[row][col] + "</td>"));
			}
			tbody.append(tr);
		}
		$("#tabData").append(tbody);
		//重新设置指标对照
		$("#tabColumns .selColumn").each(function(){
			var $this = $(this);
			$this.empty();
			$this.append($("<option value='(SKIP)'>(忽略)</option>"));
			$this.append(_.map(data.Title,function(val){
				var rev = $("<option>" + val + "</option>");	
				if(val.toUpperCase() == $this.data("field-name").toUpperCase()){
					rev.prop("selected",true);
				}
				return rev;
			}));
			$this.append($("<option value='(CUSTOM)'>(定值)</option>"));
		})
	}
	$(function(){
		showSampleData({{.More.SampleData}});
		$(".selColumn").change();
	})
	function buildCallUrl(action,param){
		var url = new URI(window.location.href);
		var pam = _.pick(url.search(true),"_s","f");
		pam.action = action;
		_.extend(pam,param);
		url.search(pam);
		return url;
	}
	$(".selColumn").change(function(){
		$(this).closest("tr").find(".edtValue").prop("disabled",$(this).val()!="(CUSTOM)");
	});
	$("#btnRefresh").click(function(){
		var pam = {
			FirstHead:$("#chkFirstLine").prop("checked"),
			Charset:$("[name=charset]:checked").val(),
			Format:$("[name=format]:checked").val(),
			CustomSplit:$("#edtCustom").val()
		};
		if(pam.Format == "CUSTOM" && pam.CustomSplit.length!=1){
			alert("必须录入一个自定义字符");
			return
		}
		var u = buildCallUrl("refreshsample",pam)
		
		$("#btnRefresh").prop("disabled",true);
		$.get(u.toString(),function(sampleData){
			showSampleData(sampleData);
		}).fail(function() {
	  	  alert( "refesh sample data error!" );
	  	}).always(function() {
			$("#btnRefresh").prop("disabled",false);
		});
	})
	$("#frmPost").submit(function(){
		//检查格式选择了自定义，自定义的字符是否录入
		var pam = {
			FirstHead:$("#chkFirstLine").prop("checked"),
			Charset:$("[name=charset]:checked").val(),
			Format:$("[name=format]:checked").val(),
			CustomSplit:$("#edtCustom").val()
		};
		if(pam.Format == "CUSTOM" && pam.CustomSplit.length!=1){
			alert("必须录入一个自定义字符");
			return false;
		}
		//检查指标对照是否全部设置
		var ok = true;
		$("#tabColumns .selColumn").each(function(){
			if($(this).data("field-style") == "MUST" && 
				(
					$(this).val() == "(SKIP)" ||
					$(this).val()=="(CUSTOM)" && 
					$(this).closest("tr").find(".edtValue").val()==""
				)
			){
				ok = false;
				alert("指标[" + $(this).data("field-name") + "]不能为空")	
				return false;
			}
		});
		if(!ok){
			return false;
		}
		//生成参数
		var fields = $("#tabColumns .selColumn").map(function(){
			return {
				FieldName:$(this).data("field-name"),
				ColumnName:$(this).val(),
				Value:$(this).closest("tr").find(".edtValue").val()
			}
		}).get();
		var p = {
			Param:pam,
			Fields:fields
		}
		$("#hidParam").val(JSON.stringify(p));
		return true;
	});
	</script>
	{{else}}
	<form role="form" action="{{.Req.URL.String}}" method="POST" enctype="multipart/form-data">
		<div class="panel panel-default">
		<!-- Default panel contents -->
		<div class="panel-heading">{{.Element.DisplayLabel}}-上传文件</div>
			<div class="panel-body">
				数据需要按照如下的格式提供，可以是CSV文件或者TAB分隔的文本文件，字符集编码默认为UTF-8
				<table class="table table-striped">
					<thead>
						<th>序号</th>
						<th>名称</th>
						<th>数据类型</th>
						<th>长度</th>
						<th>类别</th>
						<th>备注</th>
					</thead>
					<tbody>
						{{range $idx,$field :=.More.Fields}}
						<tr>
							<td>{{inc $idx}}</td>
							<td>{{$field.Name}}</td>
							<td>{{$field.Type}}</td>
							<td>{{$field.MaxLength}}</td>
							<td>{{if $field.PrimaryKey}}主键(不能重复){{else if eq "MUST" $field.Style}}必须{{else}}正常{{end}}</td>
							<td>{{$field.Remark}}</td>
						</tr>
						{{end}}
					</tbody>
				</table>
				<div class="panel panel-default">
  					<div class="panel-body">
						<p>表名:<mark>{{.More.TableName}}</mark></p>
						<p>表中总记录:<mark id="mkTableTotal">{{.More.TableTotal}}</mark></p>
						<p>可管理记录:<mark id="mkTableCanRemove">{{.More.TableCanRemove}}</mark> <button id="btnRemoveTableData" class="btn btn-default" type="button">删除</button></p>
					</div>
				</div>
				<div class="form-group">
					<label for="upFile">要上传的文件(CSV、Text格式)</label>
					<input type="file" name="upFile" id="upFile">
				</div>
			</div>
			<div class="panel-footer">
				<button id="btnUpload" type="submit" class="btn btn-default">上传</button>
			</div>
		</div>
	</form>
	<script>
		$("form").submit(function(){
			if(!$("#upFile").val()){
				alert("必须选择一个文件");
				return false;
			}
			return true;
		});
		$("#btnRemoveTableData").click(function(){
			if(confirm("是否要删除可管理的[" + $("#mkTableCanRemove").html() + "]条记录?")==false){
				return false;
			}
			var btn =$(this);
			btn.prop("disabled",true);
			$.get("{{.Req.URL.String}}&action=removetabledata",function(data){
				$("#mkTableTotal").html( data.TableTotal);
				$("#mkTableCanRemove").html( data.TableCanRemove);
				alert("成功完成删除");
			}).always(function(){
				btn.prop("disabled",false);
			}).fail(function(err){
				console.log(err);
				alert("error");
			})
		});
	</script>
	{{end}}
</div>
