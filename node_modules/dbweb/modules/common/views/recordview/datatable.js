var g_tableTop;
function refreshSel() {
	if ($(".selTD :checked").length > 0 || locationQuery.s || locationQuery.stype) {
		$("#cmbStype").prop("disabled", false);
	} else {
		$("#cmbStype").prop("disabled", true);
	}
	$("#tabData tbody tr:has(:checked)").addClass("warning");
	$("#tabData tbody tr:not(:has(:checked))").removeClass("warning");
}
function initDataTable(canTotal, totalURL, downDivide, downRowNum, upDivide, upRowNum) {
	if (canTotal) {
		$("#btnTotal").click(function () {
			$("#btnTotal").addClass("disabled", true);
			$.getJSON(totalURL, function (data) {
				if (data.Error) {
					alert(data.Error);
				} else {
					_.each(data.Data, function (value, key) {
						$("#trTotal td[data-totalfieldname=" + key + "]").html(value);
					});
					asnycHeader();
				}
				$("#btnTotal").removeClass("disabled");
			});
			return false;
		})
	}
	$("#btnUp").click(function (evt) {
		if (evt.ctrlKey) {
			getTableDataAsText();
			return false;
		}
		if (upDivide && upDivide.length > 0) {
			var url = buildUrl();
			var d = upDivide.pop();
			if (d === null) {
				url.removeSearch("divide");
				url.removeSearch("rn");
			} else {
				url.addQuery("divide", d);
				url.addQuery("rn", upRowNum.pop());
			}
			url.addQuery("uprn", upRowNum);
			url.addQuery("updivide", upDivide);
			window.location.href = url.toString();
		}
	});
	$("#btnDown").click(function (evt) {
		if (evt.ctrlKey) {
			getTableDataAsText();
			return false;
		}
		if (downDivide) {
			var url = buildUrl();
			url.addQuery("divide", downDivide);
			url.addQuery("rn", downRowNum);
			if (locationQuery.divide) {
				upDivide.push(locationQuery.divide);
				upRowNum.push(locationQuery.rn);
			} else {
				upDivide.push(null);
				upRowNum.push(0);
			}
			url.addQuery("uprn", upRowNum);
			url.addQuery("updivide", upDivide);
			window.location.href = url.toString();
		}
	});

	$(".selTD :input").click(function () {
		refreshSel();
	});
	$("#chkAll").click(function () {
		$(".selTD :input").prop("checked", $(this).prop("checked"));
		refreshSel();
	});
	$("#thNavPage").click(function (evt) {
		if (evt.ctrlKey) {
			getTableDataAsText();
			return false;
		}
	});
	function getTableDataAsText() {
		var headTr = $("#tabData thead tr");
		var headList = headTr.find("th:gt(2)").map(function () {
			return $(this).text().trim();
		}).get();
		headList.unshift("序号");

		var aList = $("#tabData tbody tr").map(function () {
			var tr = $(this).find("td:gt(2)").map(function () {
				return $(this).text().trim();
			}).get();
			tr.unshift($(this).find("td:eq(0)").text().trim());
			return tr.join("\t");
		}).get();
		aList.unshift(headList.join("\t"));
		$("#txtTableText").text(aList.join("\n"));
		$("#mdlTableText").modal();
	}
	$(".thColumn").click(function (evt) {
		if (evt.ctrlKey) {
			var idx = $(this).index();
			aList = $("#tabData tbody tr").map(function () {
				return $(this).find("td:eq(" + idx + ")").text().trim();
			}).get();
			aList.unshift($(this).text());
			$("#txtTableText").text(aList.join("\n"));
			$("#mdlTableText").modal();
		} else {
			var url = buildUrl();
			if (locationQuery.order == "-" + $(this).data("columnname")) {
				url.setSearch("order", $(this).data("columnname"));
			} else if (locationQuery.order == $(this).data("columnname")) {
				url.removeSearch("order");
			} else {
				url.setSearch("order", "-" + $(this).data("columnname"));
			}
			window.location.href = url.toString();
			return false;
		}
	});
	var $header;
	var $fixedHeader;
	g_tableTop = $("#tabData").offset().top;
	function asnycHeader() {
		if ($header) $header.remove();
		$header = $("#tabData > thead").clone(true);
		//点击合计时，会出现表格头掩藏的情况，查询后发现时clone的问题，需要下面的语句去除不正确的样式
		$header.css("visibility","");
		$header.find("th").width(function (index, ele) {
			//outerWidth返回的宽度丢失了小数部分，见下方的链接
			//https://stackoverflow.com/questions/11907514/getting-the-actual-floating-point-width-of-an-element
			return getRealWidth($("#tabData > thead th:eq(" + index + ")")[0]);
		});
		//这里不能用width，因为还有border算在内
		$("#header-fixed").outerWidth(getRealWidth($("#tabData")[0]));
		$fixedHeader = $("#header-fixed").append($header);
	}
	//---------------------------------------------------------
	asnycHeader();
	var lastScrollLeft = 0;
	function scrollDataTable() {
		var top = $(this).scrollTop();
		var left = $(this).scrollLeft();
		if (b_pushpin||(
			 top >= g_tableTop && $fixedHeader.is(":hidden"))
		 ) {
			$fixedHeader.show();
		}else if (!b_pushpin && top < g_tableTop) {
			$fixedHeader.hide();
		}
		var documentScrollLeft = $(document).scrollLeft();
		if (lastScrollLeft != documentScrollLeft) {
			var o = $fixedHeader.offset();
			o.left = 0;//使其移动
			$fixedHeader.offset(o);
			lastScrollLeft = documentScrollLeft;
		}
	}
	//$("body").on("touchmove",scrollDataTable)
	$(window).bind("scroll", scrollDataTable);
	//---------------------------------------------------------
	//shift多项选则、取消功能
	$(function () {
		var first = null;
		$("#tabData :checkbox").click(function (e) {
			if (e.shiftKey && first != null) {
				var last = $(this).closest("tr").index() + 1;
				var imin = Math.min(first, last);
				var imax = Math.max(first, last);
				var flag = $(this).prop("checked");
				for (var i = imin; i <= imax; i++) {
					$("#tabData tr").eq(i).find(":checkbox").prop("checked", flag);
				}
				first = null;
				refreshSel();
			}
			if (!e.shiftKey) {
				first = $(this).closest("tr").index() + 1;
			}
		});
	});
	$(document).on("pushpin-click",function(event,push){
		setRecordViewUI();
	});
	$(document).on("message-icon-click",function(event,show){
		setRecordViewUI();
	});
	setRecordViewUI();
}
function getRealWidth(obj) {
	var rect = obj.getBoundingClientRect();
	if (rect.width) {
		// `width` is available for IE9+
		return rect.width;
	} else {
		// Calculate width for IE8 and below
		return rect.right - rect.left;
	}
}
function getRealHeight(obj) {
	var rect = obj.getBoundingClientRect();
	if (rect.height) {
		// `width` is available for IE9+
		return rect.height;
	} else {
		// Calculate width for IE8 and below
		return rect.bottom - rect.top;
	}
}

function setRecordViewUI(){
	//没有按下图钉，则是默认的流式布局
	if (!b_pushpin) {
		$("#divRecviewMain").css("padding-top","");
		$("#navSearch").css("top","0px");
		$("#header-fixed").css("top","0px");
		$("#tabData thead").css('visibility', 'visible');
		$("#navSearch").removeClass("navbar-fixed-top").addClass("navbar-static-top");
		//需要重新计算datatable的位置
		g_tableTop= $("#tabData").offset().top;
		return;
	}
	//需要隐藏表格头，否则会乱
	$("#tabData thead").css('visibility', 'hidden');
	$("#divRecviewMain").css("padding-top","41px");
	$("#header-fixed").show();
	$("#navSearch").removeClass("navbar-static-top").addClass("navbar-fixed-top");
	if(b_messageshow){
		var h =$("#divMessage").prop("scrollHeight") + getRealHeight($("#navTitle")[0]);
		$("#navSearch").css("top",h+"px");
		$("#header-fixed").css("top",(h+getRealHeight($("#navSearch")[0]))+"px");
	} else {
		var h =getRealHeight($("#navTitle")[0]);
		$("#navSearch").css("top",h+"px");
		$("#header-fixed").css("top",(h+getRealHeight($("#navSearch")[0]))+"px");
	}
}
