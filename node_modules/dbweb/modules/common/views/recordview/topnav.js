var buildUrl;
function onDelPubCondition() {
	var url = new URI(window.location.href);
	var pam = _.pick(locationQuery, "_s");
	pam.action = "delPublic";
	pam.name = $(this).data("name");
	url.search(pam);
	$.post(url.toString(), "", function (result) {
		if (result.ok) {
			var nextUrl = buildUrl();
			nextUrl.removeSearch("pub");
			nextUrl.removeSearch("rc");
			window.location.href = nextUrl.toString();
			return false;//否则location不起作用
		} else {
			alert(result.error);
		}
	}, "json").fail(function () {
		alert("error");
	});
};

function onDelPriCondition() {
	var url = new URI(window.location.href);
	var pam = _.pick(locationQuery, "_s");
	pam.action = "delPrivate";
	pam.name = $(this).data("name");
	url.search(pam);
	$.post(url.toString(), "", function (result) {
		if (result.ok) {
			var nextUrl = buildUrl();
			nextUrl.removeSearch("pri");
			nextUrl.removeSearch("rc");
			window.location.href = nextUrl.toString();
			return false;//否则location不起作用
		} else {
			alert(result.error);
		}
	}, "json").fail(function () {
		alert("error");
	});
};
function initTopNav(userDeptCode, defaultDspCols, showSql,txtSQL) {
	$.contextMenu({
		// define which elements trigger this menu
		selector: ".pub-condition,.pri-condition",
		// define the elements of the menu
		items: {
			edit: {
				name: "修改", icon: "edit", callback: function (key, opt) {
					var name = opt.$trigger.data("name");
					var url = new URI(window.location.href);
					var pam = _.pick(locationQuery, "_s");
					pam.action = "gv";
					pam.evname = opt.$trigger.data("name");
					pam.pub = opt.$trigger.data("pub");
					url.search(pam);
					var title;
					var pub = false;
					if (pam.pub == "1") {
						title = "修改公共模板";
						pub = true;
					} else {
						title = "修改私有模板";
					}
					$.getJSON(url.toString(), function (evdefine) {
						showQueryDefine(title, evdefine, function (data) {
							var url = new URI(window.location.href);
							var pam = _.pick(locationQuery, "_s");
							if (pub) {
								pam.action = "editPublic";
							} else {
								pam.action = "editPrivate";
							}

							pam.old = name;
							url.search(pam);
							$.post(url.toString(), JSON.stringify(data), function (result) {
								if (result.ok) {
									var nextUrl = buildUrl();
									if (pub)
										nextUrl.setSearch("pub", userDeptCode + '.' + data.Name);
									else
										nextUrl.setSearch("pri", data.Name);
									nextUrl.removeSearch("rc");
									window.location.href = nextUrl.toString();
									return false;//否则location不起作用
								} else {
									alert(result.error);
								}
							}, "json").fail(function () {
								alert("error");
							});
						});
					});
				}
			},
			remove: {
				name: "删除", icon: "delete", callback: function (key, opt) {
					if (opt.$trigger.data("pub") == "1")
						$("#confirm-delete").data("click", "onDelPubCondition");
					else
						$("#confirm-delete").data("click", "onDelPriCondition");
					$("#confirm-delete").data("name", opt.$trigger.data("name"));
					$("#confirm-delete").modal("show");
				}
			}
		},
		events: {
			show: function (options) {
				return $(this).data("pub") != "1" || $(this).data("canmodify") == "1";
			},
		}
		// there's more, have a look at the demos and docs...
	});

	buildUrl = function () {
		var url = new URI(window.location.href);
		var pam = _.pick(locationQuery, "_more", "order", "pub", "pri", "_s", "s", "stype", "_tq_title", "_tq_condition");
		pam.field = $("#cmbField").val();
		pam.opt = $("#cmbOpt").val();
		pam.val = $("#edtValue").val();
		if (!pam.field || !pam.opt) {
			delete pam.field;
			delete pam.opt;
			delete pam.val;
		}
		//选中的主键，需要将当前页中，选中的加上，减掉未选中的
		//！！！暂时不考虑，当仅显示选中或者未选中时，翻页且修改选中，引起的异常！！！
		var selKeys = $.map($(".selTD :checked"), function (v) {
			return $(v).data("key");
		});
		var notselKeys = $.map($(".selTD :not(:checked)"), function (v) {
			return $(v).data("key");
		});
		pam.s = _.without.apply(_, [_.union(pam.s, selKeys)].concat(notselKeys));
		if (!pam.s || pam.s.length == 0) {
			delete pam.s;
		}
		var queryS = locationQuery.s;
		//如果是单个选择，则需要转换成数组,因为数组在query中传递就有这个问题
		if (queryS && !_.isArray(queryS)) queryS = [queryS];
		if (rowCount > -1 &&
			locationQuery.stype == pam.stype &&
			locationQuery.field == pam.field &&
			locationQuery.opt == pam.opt &&
			locationQuery.val == pam.val &&
			_.difference(queryS, pam.s).length == 0) {
			pam.rc = rowCount;
		}
		url.search(pam);
		return url;
	};
	$("#btnOk").click(function () {
		//确定按钮刷新的，保留下列的参数
		var url = buildUrl();
		//仅仅在确定按钮按下才会起作用
		var oldStyle = locationQuery.stype ? locationQuery.stype : "";
		if (oldStyle != $("#cmbStype").val()) {
			url.removeSearch("rc");
			if ($("#cmbStype").val()) {
				url.setSearch("stype", $("#cmbStype").val());
			} else {
				url.removeSearch("stype");
			}
		}
		window.location.href = url.toString();
		return false;
	});
	$("#addPublic").click(function () {
		showQueryDefine("新增公用模板", {
			Name: "new name",
			DspCols: defaultDspCols
		}, function (data) {
			var url = new URI(window.location.href);
			var pam = _.pick(locationQuery, "_s");
			pam.action = "addPublic";
			url.search(pam);
			$.post(url.toString(), JSON.stringify(data), function (result) {
				if (result.ok) {
					var nextUrl = buildUrl();
					nextUrl.setSearch("pub", userDeptCode + '.' + data.Name);
					nextUrl.removeSearch("rc");
					window.location.href = nextUrl.toString();
					return false;
				} else {
					alert(result.error);
				}
			}, "json").fail(function () {
				alert("error");
			});
		});
	});
	$("#addPrivate").click(function () {
		showQueryDefine("新增私用模板", {
			Name: "new name",
			DspCols: defaultDspCols
		}, function (data) {
			var url = new URI(window.location.href);
			var pam = _.pick(locationQuery, "_s");
			pam.action = "addPrivate";
			url.search(pam);
			$.post(url.toString(), JSON.stringify(data), function (result) {
				if (result.ok) {
					var nextUrl = buildUrl();
					nextUrl.setSearch("pri", data.Name);
					nextUrl.removeSearch("rc");
					window.location.href = nextUrl.toString();
					return false;
				} else {
					alert(result.error);
				}
			}, "json").fail(function () {
				alert("error");
			});
		});
	});

	$("#emptyPublic").click(function () {
		var nextUrl = buildUrl();
		nextUrl.removeSearch("pub");
		nextUrl.removeSearch("rc");
		window.location.href = nextUrl.toString();
		return false;//否则location不起作用
	});
	$("#emptyPrivate").click(function () {
		var nextUrl = buildUrl();
		nextUrl.removeSearch("pri");
		nextUrl.removeSearch("rc");
		window.location.href = nextUrl.toString();
		return false;//否则location不起作用
	});
	$(".pub-condition").click(function () {
		var nextUrl = buildUrl();
		nextUrl.setSearch("pub", $(this).data("name"));
		nextUrl.removeSearch("rc");
		window.location.href = nextUrl.toString();
		return false;//否则location不起作用
	});
	$(".pri-condition").click(function () {
		var nextUrl = buildUrl();
		nextUrl.setSearch("pri", $(this).data("name"));
		nextUrl.removeSearch("rc");
		window.location.href = nextUrl.toString();
		return false;//否则location不起作用
	});
	$("#cmbField").select2();
	$("#cmbOpt").select2();
	$(function () {
		if (locationQuery.field) $("#cmbField").val(locationQuery.field).trigger("change");
		if (locationQuery.opt) $("#cmbOpt").val(locationQuery.opt).trigger("change");
		if (locationQuery.val) $("#edtValue").val(locationQuery.val);
		if (locationQuery.stype) $("#cmbStype").val(locationQuery.stype);
		if (locationQuery.s) selKeys = locationQuery.s;
		refreshSel();

	});
	if (showSql) {
		var txtSelectSql = ace.edit("txtSelectSql");
		txtSelectSql.setTheme("ace/theme/sqlserver");
		txtSelectSql.getSession().setMode("ace/mode/sql");
		txtSelectSql.setValue(txtSQL,2);
		txtSelectSql.setReadOnly(true);
		$(document).keydown(function (event) {
			if (event.keyCode == 123) {//F12
				$("#dlgSql").modal("show");
			}
		});
	}
}