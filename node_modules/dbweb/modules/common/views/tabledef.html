<style>
.checkbox{
	margin-top: 5px;
	margin-bottom: 0px;
}
body{
	padding-top:15px;
	background-color:dimgray;
}
#divMain{
	max-width:800px;
    float: none;
    margin-left: auto;
    margin-right: auto;
	margin-bottom:0px;
}
#divContent{
	margin-bottom:40px;
}
.form-group {
    margin-bottom: 4px;
}
.control-label{
	padding-right:0px;
}
</style>
<script type="text/template" id="fieldTmpl">
<tr>
	<td>
	{{if ne .Element.Name "browsetabledef"}}
		<span class='btn-group btn-group-sm'>
			<button type='button' class='btn btn-primary btnAdd'><i class='fa fa-plus'></i></button>
			<button type='button' class='btn btn-danger btnDelete'><i class='fa fa-minus'></i></button>
		</span>
	{{end}}
	</td>
	<td ><p class="field-no form-control-static"></p></td>
	<td>
		<input type='text' class='form-control field-name' maxlength="15" {{if eq .Element.Name "browsetabledef"}}readonly{{end}}>
	</td>
	<td>
		<select class='form-control field-type' {{if eq .Element.Name "browsetabledef"}}disabled{{end}}>
			<option value='STR'>字符串</option>
			<option value='INT'>整型</option>
			<option value='FLOAT'>浮点数</option>
			<option value='DATE'>日期</option>
			<option value='BYTEA'>二进制</option>
		</select>
	</td>
	<td>
		<input type='number' class='form-control field-len' style="width:80px" {{if eq .Element.Name "browsetabledef"}}readonly{{end}}>
	</td>
	<td>
		<div class='checkbox checkbox-success'>
			<input type='checkbox' class='field-key' {{if eq .Element.Name "browsetabledef"}}disabled{{end}}>
			<label class="field-key-label">主键</label>
		</div>
	</td>
	<td>
		<div class='checkbox checkbox-success'>
			<input type='checkbox' class='field-notnull' {{if eq .Element.Name "browsetabledef"}}disabled{{end}}>
			<label class="field-notnull-label">非空</label>
		</div>
	</td>
	<td>
		<div class='checkbox checkbox-success'>
			<input type='checkbox' class='field-index' {{if eq .Element.Name "browsetabledef"}}disabled{{end}}>
			<label class="field-index-label">索引</label>
		</div>
	</td>
	<td>
		{{if ne .Element.Name "browsetabledef"}}
		<span class='btn-group btn-group-sm'>
			<button type='button' class='btn btn-default btnUp'><i class='fa fa-arrow-up'></i></button>
			<button type='button' class='btn btn-default btnDown'><i class='fa fa-arrow-down'></i></button>
		</span>
		{{end}}
	</td>
</tr>
</script>
<div id="divMain" class="panel panel-default">
	<div class="panel-heading">
		<h3 class="panel-title" >{{.Element.DisplayLabel}}</h3>
	</div>
	<div class="panel-body" id="divContent">
		<form  class="form-horizontal">
			<div class="form-group">
				<label for="edtName" class="control-label col-md-1">名称:</label>
				<div class="col-md-5">
					<input id="edtName" class="form-control" type="text" {{if (in .Element.Name "edittabledef_noname" "browsetabledef")}}disabled="disabled"{{end}} value="{{.More.TableDefine.FullName}}">
				</div>
				<label for="edtDBName" class="control-label col-md-1">数据库:</label>
				<div class="col-md-5">
					<input id="edtDBName" class="form-control" type="text" value="{{.More.DBName}}" disabled="disabled">
				</div>
			</div>
			<fieldset>
			<legend>字段定义</legend>
			<table class="table table-striped table-hover">
				<thead>
					<tr>
						<th></th>
						<th>序号</th>
						<th>字段名</th>
						<th>数据类型</th>
						<th>长度</th>
						<th>主键</th>
						<th>非空</th>
						<th>索引</th>
						<th></th>
					</tr>
				</thead>
				<tbody id="fields" data-bill-fieldname="define">
				</tbody>
			</table>
			</fieldset>
		</form>
	</div>
</div>	
<div id="divFooter" >
	<nav class='navbar navbar-inverse navbar-fixed-bottom' role='navigation' id="navBottom">
		<div class='container-fluid'>
			<div class='navbar-header'>
				<button type='button' class='navbar-toggle' data-toggle='collapse' data-target='#bottom_navbar_collepse'>
					<span class='sr-only'>Toggle navigation</span>
					<span class='icon-bar'></span>
					<span class='icon-bar'></span>
					<span class='icon-bar'></span>
				</button>
			</div>
			<div class='navbar-collapse collapse' id='bottom_navbar_collepse'>
				<form class="navbar-form navbar-right" role="search">
					{{if ne .Element.Name "browsetabledef"}}
					<button id="btnOk" class="btn btn-primary navbar-btn" type="button"><i class="fa fa-floppy-o" ></i> 保存</button>
					{{end}}
					<button id="btnCancel" class="btn btn-default navbar-btn" type="button"><i class="fa fa-times"></i> 关闭</button>
				</form>
			</div>
		</div>
	</nav>
</div>

<script>
var maxIndex = 0;
function collectionField(tr){
	return {
		Name:{
			Old:tr.find(".field-name").data("old"),
			New:tr.find(".field-name").val()
		},
		Type:tr.find(".field-type").val(),
		Len:parseInt(tr.find(".field-len").val()),
		Key:tr.find(".field-key").prop("checked"),
		NotNull:tr.find(".field-notnull").prop("checked"),
		Index:tr.find(".field-index").prop("checked")
	}
}
function newFieldRow(fieldName,fieldType,fieldLen,fieldKey,fieldNotNull,fieldIndex){
	maxIndex ++;
	var row = $($("#fieldTmpl").html())
	var notnullId = "fieldNotNull"+maxIndex;
	var keyId = "fieldKey"+maxIndex;
	var indexID = "fieldIndex"+maxIndex
	row.find(".field-key").attr("id",keyId);
	row.find(".field-notnull").attr("id",notnullId);
	row.find(".field-index").attr("id",indexID);
	row.find(".field-key-label").attr("for",keyId);
	row.find(".field-notnull-label").attr("for",notnullId);
	row.find(".field-index-label").attr("for",indexID);
	
	row.find(".field-name").data("old",fieldName);

	row.find(".field-name").val(fieldName);
	row.find(".field-type").val(fieldType);
	row.find(".field-len").val(fieldLen);
	row.find(".field-key").prop("checked",fieldKey);
	row.find(".field-notnull").prop("checked",fieldNotNull);
	row.find(".field-index").prop("checked",fieldIndex);
	
	row.find(".btnAdd").click(rowAdd);
	row.find(".btnDelete").click(rowRemove);
	
	row.find(".btnUp").click(btnUpClick);
	row.find(".btnDown").click(btnDownClick);
	return row;
}
function btnUpClick(){
	var tr = $(this).closest("tr");
	if(tr.index()>0){
		tr.after(tr.prev());
	}
	setFieldsNo();
}
function btnDownClick(){
	var tr = $(this).closest("tr");
	if(tr.index()< tr.parent().find("tr").length-1){
		tr.next().after(tr);
	}
	setFieldsNo();
}
function rowAdd(){
	var tr = $(this).closest("tr");
	tr.after(newFieldRow("","STR",50,false,false,false));
	setFieldsNo();
}
function rowRemove(){
	var tr = $(this).closest("tr").remove();
	setFieldsNo();
}
function setFieldsNo(){
	$("#fields tr").each(function(){
		$(this).find(".field-no").text($(this).index()+1);
	});
}
var pks = {{.More.TableDefine.PrimaryKeys}};
{{range $idx,$field:=.More.TableDefine.Columns}}
	$("#fields").append(newFieldRow({{$field.Name}},{{$field.Type.String}},{{$field.MaxLength}},_.contains(pks,{{$field.Name}}),{{not $field.Null}},{{$field.Index}}));
{{else}}
	$("#fields").append(newFieldRow("","STR",0,false,false,false));
{{end}}
setFieldsNo();
$("#btnOk").click(function(){
	var rows = $("#fields tr").map(function(){
		return collectionField($(this));
	}).get();
	$("#btnOk,#btnCancel").prop("disabled",true);
	$.post(window.location.href,
		JSON.stringify({
			Fields:rows
		}),
		function(data){
			if(data.Error){
				alert(data.Error);
			}else{
				window.close();
			}
		}
	).fail(function() {
  	  alert( "error" );
  	}).always(function(){
		$("#btnOk,#btnCancel").prop("disabled",false);
	})
});
$("#btnCancel").click(function(){
	close();
})


</script>