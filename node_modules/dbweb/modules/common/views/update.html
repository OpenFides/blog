<style type="text/css">
.tdName{
	white-space:nowrap;
}
.tdValue{
	white-space:normal;
}
.tdValue .checkbox{
	margin-left:0px;
	padding-left:5px;
}
.hastooltip{
	color:red;
}
</style>
<form role="form" action="{{.Req.URL.String}}" method="POST">
<div class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">{{.Element.DisplayLabel}}-{{.More.FromElement.DisplayLabel}}{{template "helpicon" .}}</h4>
      </div>
      <div class="modal-body">
        <div class="alert alert-success" role="alert">
			<h4>将要更新的记录数: <span class="label label-primary">{{.More.SrcRowCount}}</span></h4>
		</div>
		<table id="tabUpdate" class="table table-hover table-condensed table-striped">
			<thead>
				<th style="width:10%">序号</th>
				<th style="width:10%">名称</th>
				<th style="width:70%">值(表达式用`包括,NULL用``)</th>
			</thread>
			<tbody>
			{{range $idx,$field :=.More.Fields}}
				<tr>
					<td>{{inc $idx}}</td>
					<td class="tdName">
						<div class="checkbox checkbox-inline checkbox-success">
							<input type="checkbox" class="chkSelect" id="chk{{$idx}}" name="sel_{{$field.Name}}" {{if $field.Must}}onclick="return false" checked="checked"{{end}}>
							<label class="lblFieldName" for="chk{{$idx}}" {{with $field.Tooltip}}data-toggle="tooltip" data-placement="top" title="{{.}}"{{end}}>
								{{- if $field.Label}}{{$field.Label}}[{{$field.Name}}]{{else}}{{$field.Name}}{{end}}
								{{- if $field.Tooltip}}<span class="hastooltip">*</span>{{end}}</label>
						</div>
					</td>
					<td class="tdValue">
					{{if $field.Freeentry}}
						<div class="input-group">
							<input name="val_{{$field.Name}}" type="text" class="form-control edtValue">
							<div class="input-group-btn">
								<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">选择 <span class="caret"></span></button>
								<ul class="dropdown-menu dropdown-menu-right">
								{{range $listIdx,$list:=$field.List}}
									<li><a href="#" data-value="{{.Value}}" class="menValueListItem">{{ifn .Label .Value}}</a></li>
								{{end}}
								</ul>
							</div><!-- /btn-group -->
						</div><!-- /input-group -->
					{{else}}
						{{range $listIdx,$list:=$field.List}}
						<div class="checkbox checkbox-primary checkbox-inline">
							<input type="radio" name="val_{{$field.Name}}" id="rdo{{$idx}}_{{$listIdx}}" autocomplete="off" value="{{.Value}}">
							<label for="rdo{{$idx}}_{{$listIdx}}">{{ifn .Label .Value}}</label>
						</div>
						{{end}}
					{{end}}
					</td>
				</tr>
			{{end}}
			</tbody>
		</table>
		<div id="divError" class="alert alert-danger" role="alert" style="display:none"></div>
      </div>
	
      <div class="modal-footer">
			<button id="btnOk" type="submit" class="btn btn-primary" {{if eq .More.SrcRowCount 0}} disabled="disabled"{{end}}><i class="fa fa-check"></i> 执行</button>
	        <button id="btnClose" type="button" class="btn btn-default"><i class="fa fa-close"></i> 关闭</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
</form>
<script>
$("#tabUpdate tbody .chkSelect").change(function(){
	$(this).closest("tr").find(":input,button").not(".chkSelect").prop("disabled",!$(this).prop("checked"));
	if($(this).prop("checked")){
		$(this).closest("tr").removeClass("text-muted");
	}else{
		$(this).closest("tr").addClass("text-muted");
	}
});
$("#tabUpdate tbody .chkSelect").change();
$("#tabUpdate tbody .menValueListItem").click(function(){
	$(this).closest(".tdValue").find(".edtValue").val($(this).data("value"));
});
$(".modal").modal({backdrop:"static"});

$("#btnClose").click(function(){
	window.close();
})
$("form").submit(function(){
	$("#tabUpdate tbody>tr").removeClass("has-error");
	$("#divError").hide();
	var error = false;
	{{if .More.Fields}}
	if(!$("#tabUpdate tbody>tr .chkSelect").is(":checked")){
		$("#divError").html("没有选择字段");
		error=true;
		$("#divError").show();
	}
	{{end}}
	$("#tabUpdate tbody>tr").each(function(){
		if($(this).find(".chkSelect").prop("checked")){
			var radList = $(this).find(".tdValue :radio");
			var edtValue = $(this).find(".tdValue .edtValue");
			var fieldName = $(this).find(".lblFieldName").html();
			if(radList.length>0 && !radList.is(":checked")){
				$("#divError").html("["+fieldName+"] 不能为空");
				$(this).addClass("has-error");
				error=true;
				$("#divError").show();
				return null;
			}else if(edtValue.length>0 && edtValue.val()==""){
				$("#divError").html("["+fieldName+"] 不能为空");
				$(this).addClass("has-error");
				error=true;
				$("#divError").show();
				return null;
			}
		}
	});
	return !error;
});
$(function () {
  $('[data-toggle="tooltip"]').tooltip({container: 'body'});
});
</script>